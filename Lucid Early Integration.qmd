---
title: "Lucid Early Integration"
author: "Jesse Goodrich, Hongxu Wang, Qiran Jia, and David Conti"
format: 
  html:
    code-fold: true
---

## *Set up project for Lucid Early Integration Analysis*

```{r lucid early integration setup, include = FALSE, echo = FALSE}
source(fs::path(here::here(),"project_setup","directories.R"))
source(fs::path(dir_proj,"libraries.R"))
source(fs::path(dir_proj,"load_simu_data.R"))
source(fs::path(dir_proj, "functions","lucid_reorder_plot_without_y.R"))
source(fs::path(dir_proj, "functions",
                "LUCIDus Early Integration Sankey fxn.R"))
source(fs::path(dir_proj, "functions", "LUCIDus", "dependency.R"))
library(htmlwidgets)
#need knitr version 1.42 to be compatible with htmlwidgets when rendering
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height= 15, fig.width= 12,collapse = TRUE)
```

```{r analysis data preparation}
# Three omics layers, Methylation (CpG), Transcriptome and miRNA
omics_df_analysis <- omics_df %>% 
  select(contains("cg"), contains("TC"), contains("hsa"))
```

## *Analysis: LUCID with early integration*

**Exposure: Hg (Mercury)**

**Omics: Methylation (CpG), Transcriptome, miRNA**

**Outcome: c18_scld**

**Covars: sex, age, ?**

```{r LUCID model 1 early integration, fig.height= 15, fig.width= 12,collapse = TRUE}
G = exposure %>%
  as.matrix()
Z = omics_df_analysis %>% 
  as.matrix()

fit1 <- estimate_lucid(lucid_model = "early",
              G = G,
              Z = Z,
              Y = outcome, 
              K = 2,
              CoY = covs,
              CoG = covs,
              useY = TRUE,
              init_par = "random",
              family = "normal")


# Sankey Diagram
sankey_early_integration(fit1, text_size = 20)
```

## *Omics profiles for each cluster predicted by LUCID*

```{r early integration omics profiles, fig.height= 10, fig.width= 10}
M_mean = as.data.frame(fit1$pars$mu)
M_mean$cluster = as.factor(1:2)
M_mean_melt = reshape::melt(M_mean, id.vars = "cluster") 
M_mean_melt <- M_mean_melt %>% 
  mutate(cluster = ifelse(cluster == 2, "High Risk", "Low Risk"))
# add color label for omics layer
M_mean_melt = M_mean_melt %>%
  mutate(color_label = case_when(str_detect(variable,  "cg") ~ "1", 
                                 str_detect(variable, "TC") ~ "2", 
                                 TRUE ~ "3"))

ggplot(M_mean_melt, aes(fill = color_label, y = value, x = variable)) +
  geom_bar(position="dodge", stat="identity") +
  ggtitle("Omics profiles for 2 latent clusters - Lucid early integration") +
  # facet_wrap(~(cluster)) +
  facet_grid(rows = vars(cluster), scales = "free_y") +
  theme(legend.position="none") +
  geom_hline(yintercept = 0) +
  xlab("") +
  theme(text = element_text(size=10),
        axis.text.x = element_text(angle = 90, vjust = 1,
                                   hjust = 1),
        plot.margin = margin(10, 10, 10, 80),
        panel.background = element_rect(fill="white"), 
        strip.background = element_rect(fill = "white"),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),) +
  scale_fill_manual(values = c("#2fa4da", "#A77E69", "#e7b6c1"))

```
